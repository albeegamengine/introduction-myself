name: AI Code Review with Gemini

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

jobs:
  ai-review:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install google-genai requests

      - name: Get PR diff
        id: diff
        run: |
          git fetch origin ${{ github.base_ref }}
          git diff origin/${{ github.base_ref }}...HEAD > pr_diff.txt

          DIFF_SIZE=$(wc -c < pr_diff.txt)
          echo "diff_size=$DIFF_SIZE" >> $GITHUB_OUTPUT

      - name: Load knowledge base
        id: knowledge
        run: |
          KNOWLEDGE=""
          if [ -d ".github/knowledge" ]; then
            for file in .github/knowledge/*.md; do
              if [ -f "$file" ]; then
                echo "Loading: $file"
                KNOWLEDGE="$KNOWLEDGE\n\n## $(basename $file)\n\n$(cat $file)"
              fi
            done
          fi

          echo "KNOWLEDGE_BASE<<EOF" >> $GITHUB_ENV
          echo "$KNOWLEDGE" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: AI Code Review
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPO_NAME: ${{ github.repository }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_AUTHOR: ${{ github.event.pull_request.user.login }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cat > review.py << 'EOF'
          from google import genai
          import os
          import requests
          import sys

          # Gemini APIè¨­å®š
          client = genai.Client(api_key=os.environ['GEMINI_API_KEY'])

          # PRæƒ…å ±å–å¾—
          pr_number = os.environ['PR_NUMBER']
          repo_name = os.environ['REPO_NAME']
          pr_title = os.environ['PR_TITLE']
          pr_author = os.environ['PR_AUTHOR']

          # Diffãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿
          try:
              with open('pr_diff.txt', 'r', encoding='utf-8') as f:
                  diff_content = f.read()
          except FileNotFoundError:
              diff_content = "No changes detected."

          knowledge_base = os.environ.get('KNOWLEDGE_BASE', '')

          prompt = f"""ã‚ãªãŸã¯çµŒé¨“è±Šå¯Œãªã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ã‚¢ãƒ¼ã§ã™ã€‚ä»¥ä¸‹ã®Pull Requestã‚’ç¤¾å†…ã®ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¦ç´„ã¨ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã«åŸºã¥ã„ã¦ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã¦ãã ã•ã„ã€‚

          # PRæƒ…å ±
          - ã‚¿ã‚¤ãƒˆãƒ«: {pr_title}
          - ä½œæˆè€…: {pr_author}

          # ç¤¾å†…ãƒŠãƒ¬ãƒƒã‚¸ãƒ™ãƒ¼ã‚¹
          {knowledge_base}

          # ãƒ¬ãƒ“ãƒ¥ãƒ¼å¯¾è±¡ã®ã‚³ãƒ¼ãƒ‰å·®åˆ†
          {diff_content[:50000]}

          # ãƒ¬ãƒ“ãƒ¥ãƒ¼æŒ‡é‡
          1. ç¤¾å†…ãƒŠãƒ¬ãƒƒã‚¸ãƒ™ãƒ¼ã‚¹ã«è¨˜è¼‰ã•ã‚ŒãŸãƒ«ãƒ¼ãƒ«ã«é•åã—ã¦ã„ãªã„ã‹ç¢ºèª
          2. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¸Šã®å•é¡ŒãŒãªã„ã‹
          3. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹ã®æ”¹å–„ä½™åœ°ã¯ãªã„ã‹
          4. å¯èª­æ€§ã¨ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹æ€§
          5. ãƒ†ã‚¹ãƒˆã®æœ‰ç„¡ã¨å“è³ª

          # å‡ºåŠ›å½¢å¼
          ä»¥ä¸‹ã®Markdownå½¢å¼ã§å‡ºåŠ›ã—ã¦ãã ã•ã„ï¼š

          ## ðŸŽ¯ ç·åˆè©•ä¾¡
          [LGTM / è¦ä¿®æ­£ / è¦è­°è«–]

          ## âœ… è‰¯ã„ç‚¹
          - ...

          ## âš ï¸ æ”¹å–„ææ¡ˆ
          ### é‡è¦åº¦: é«˜
          - ...

          ### é‡è¦åº¦: ä¸­
          - ...

          ### é‡è¦åº¦: ä½Ž
          - ...

          ## ðŸ’¡ å‚è€ƒæƒ…å ±
          - ...

          ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚³ãƒ¡ãƒ³ãƒˆã¯å»ºè¨­çš„ã‹ã¤å…·ä½“çš„ã«ã€æ—¥æœ¬èªžã§è¨˜è¿°ã—ã¦ãã ã•ã„ã€‚
          """

          def generate_review():
              models_to_try = [
                  'gemini-2.5-flash',      # æœ€æ–°ã‹ã¤é«˜é€Ÿï¼ˆç¬¬ä¸€å€™è£œï¼‰
                  'gemini-2.0-flash',      # å®‰å®šç‰ˆãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
                  'gemini-2.5-pro',        # é«˜ç²¾åº¦ç‰ˆãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
                  'gemini-flash-latest'    # ã‚¨ã‚¤ãƒªã‚¢ã‚¹
              ]

              for model_name in models_to_try:
                  print(f"ðŸ”„ Trying model: {model_name}...")
                  try:
                      response = client.models.generate_content(
                          model=model_name,
                          contents=prompt
                      )
                      return response.text
                  except Exception as e:
                      print(f"âš ï¸ Failed with {model_name}: {str(e)}")
                      # 404ã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯æ¬¡ã®ãƒ¢ãƒ‡ãƒ«ã‚’è©¦ã™
                      if "404" in str(e) or "not found" in str(e).lower():
                          continue
                      raise e
              
              raise Exception("âŒ All specified models failed.")

          try:
              review_comment = generate_review()
              
              print("=== AI Review Generated ===")
              print(review_comment)
              
              # GitHub APIã§PRã«ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿
              github_token = os.environ.get('GITHUB_TOKEN')
              if github_token:
                  api_url = f"https://api.github.com/repos/{repo_name}/issues/{pr_number}/comments"
                  headers = {
                      'Authorization': f'token {github_token}',
                      'Accept': 'application/vnd.github.v3+json'
                  }
                  
                  comment_body = f"## ðŸ¤– AI Code Review (Gemini 2.5)\n\n{review_comment}\n\n---\n*ã“ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¯Gemini APIã«ã‚ˆã£ã¦è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚*"
                  
                  response = requests.post(
                      api_url,
                      headers=headers,
                      json={'body': comment_body}
                  )
                  
                  if response.status_code == 201:
                      print("âœ… Review comment posted successfully!")
                  else:
                      print(f"âŒ Failed to post comment: {response.status_code}")
              else:
                  print("âš ï¸ GITHUB_TOKEN not found, skipping comment posting")
                  
          except Exception as e:
              print(f"âŒ Error during review generation: {str(e)}")
              
              print("\nðŸ” Available models:")
              try:
                  for m in client.models.list(config={'page_size': 10}):
                      print(f"- {m.name}")
              except:
                  pass
              sys.exit(1)
          EOF

          python3 review.py

      - name: Save review to history
        if: success()
        run: |
          mkdir -p .github/knowledge/past-reviews
          DATE=$(date +%Y%m%d-%H%M%S)
          PR_NUM=${{ github.event.pull_request.number }}
          echo "PR #$PR_NUM reviewed at $DATE" > .github/knowledge/past-reviews/pr-${PR_NUM}-${DATE}.log
